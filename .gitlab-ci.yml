stages:
  - build
  - security

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

variables:
  SBOM_FILE: sbom.cdx.json

generate_sbom:
  stage: build
  image: node:20
  script:
    - npm ci
    - npx @cyclonedx/cyclonedx-npm --output-file $SBOM_FILE --output-format json --include-dev
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - $SBOM_FILE

dependency_check:
  stage: security
  image: owasp/dependency-check:latest
  needs: ["generate_sbom"]
  script:
    - mkdir -p reports
    - dependency-check.sh --scan . --format HTML --out reports
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - reports/