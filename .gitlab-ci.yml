stages:
  - build
  - security

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

variables:
  SBOM_FILE: sbom.cdx.json

generate_sbom:
  stage: build
  image: node:20
  script:
    - npm ci
    - npx @cyclonedx/cyclonedx-npm --output-file $SBOM_FILE --output-format json --include-dev
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - $SBOM_FILE

dependency_check:
  stage: security
  image: owasp/dependency-check:latest
  needs: ["generate_sbom"]
  variables:
    DC_DATA: "$CI_PROJECT_DIR/odc-data-$CI_PIPELINE_ID-$CI_JOB_ID"
  script:
    - mkdir -p reports "$DC_DATA"
    - rm -rf "$DC_DATA"/*
    - dependency-check.sh
        --scan "$CI_PROJECT_DIR"
        --format HTML
        --out "$CI_PROJECT_DIR/reports"
        --data "$DC_DATA"
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - reports/
